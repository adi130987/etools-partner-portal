

<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../etools-ajax/etools-ajax.html">
<!--
An element providing a solution to no problem in particular.

Example:

    <my-customel></my-customel>

@group Seed Elements
@element my-customel
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="global-data">
  <template>
    

    <etools-ajax
          autos
          id="ajax"
          url="[[userUrl]]"
          handle-as="json"
          on-response="handleUserResponse"
          on-error="handleError"
          debounce-duration="300">
    </etools-ajax>


  </template>
</dom-module>

<script>
    // jscs:disable
(function() {
    
  'use strict';
  Polymer({
    is: 'global-data',
    properties: {
      appData: {
        type: Object,
        // appData is received from the parent
        value: {}
      },
      user: {
        type: Object,
        notify: true,
        value: function() {return {};}
      },
      userUrl: {
        type: String,
        value: null
      },
      permissions: {
        type: Object,
        notify: true,
        value: function() {return{default:true};}
      }
    },
    ready: function() {
      // console.log(this.appData);
      // console.log(this.appData.getEndpoint.userProperties(2));
      // TODO: fire the ajax request at this point
      this.userUrl = this.appData.userInfoEp;
    },
    computeUrl: function(appData) {
        return appData.userInfoEp;
    },
    _setDefaultUser: function(){
      var defaultUser = {
        'id': null,
        'profile': {'office': null,
                    'section': null,
                    'country_name': 'UAT',
                    'partner_staff_member': null,
                    'job_title': null,
                    'phone_number': null,
                    'installation_id': null,
                    'country': 1,
                    'country_override': null},
        'last_login': '2015-12 04T19:24:08.714193Z', 
        'is_superuser': false, 
        'username': 'email@example.com', 
        'first_name': 'Anonymous',
        'last_name': 'User',
        'email': 'email@example.com',
        'is_staff': false,
        'is_active': true,
        'date_joined': '2015-12-03T16:17:01Z'
      };
      var defaultPermissions = {
        default: true
      };
      console.log('setting default user');
      this.user = defaultUser;
      console.log('setting default permissions');
      this.permissions = defaultPermissions;

      // For testing only:
      // if (defaultUser.id){
      //   this._setPermissions(this.user);
      // }
    },

    handleError: function(rsp, err){
      console.log(rsp);
      console.log(err);
      this._setDefaultUser();
    },
    handleUserResponse: function(rsp) {
      // console.log(rsp.detail, rsp, rsp.response)
      // console.log(rsp.detail.xhr.responseURL);
      // console.log(rsp.srcElement.url);
      // TODO: move this logic into default behaviours
      if (rsp.detail.xhr.responseURL !== rsp.srcElement.url){
        console.error('expected link did not work, got redirected');
        // TODO: if we get redirected to login.. trigger a global redirect mechanism
        this._setDefaultUser();
        return;
      }
      // TODO: check response to make sure it contains a valid user
      this.user = rsp.detail.xhr.response;
      this._setPermissions(this.user);
    },

    checkMe: function(user) {
      return user.id || false;
    },

    _setPermissions: function(user) {
      var myPermisions = {'loggedInDefault':true};
      // add all default permissions (while testing these are set to all permissions)
      var defaultPermissions = this.appData.permissions.defaultPermissions;
      for (var dperm in defaultPermissions) {
        myPermisions[defaultPermissions[dperm]] = true;
      }
      if (!user.is_staff) {
        var partnerOnlyPermissions = this.appData.permissions.partnerOnlyPermissions;
        for (var perm in partnerOnlyPermissions) {
          myPermisions[partnerOnlyPermissions[perm]] = true;
        }
      }
      if (user.profile.partner_staff_member){
        this.appData.permissions.partnerPermissions.forEach(function(perm){
          myPermisions[perm] = true;
        });
      }
      this.set('permissions', myPermisions);
    }
    
  });
})();

</script>