
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">


<link rel="import" href="../../common/locations-autocomplete/locations-autocomplete.html">
<link rel="import" href="../../common/timeframe-picker/timeframe-picker.html">
<link rel="import" href="../value-breakdown/value-breakdown.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../common/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../behaviors/common/utils.html">


<dom-module id="intervention-details">
  <template>
  <style>
  :host {
    
  }
  :root {
      --paper-tab-ink: var(--default-primary-color);

      /* custom CSS property */
      --paper-tabs-selection-bar-color: blue;

      /* custom CSS mixin */
      --paper-tabs: {
          color: var(--default-primary-color); /* variable defined in default-theme.html */
      }
  }
   paper-material {
      padding: 1%;
      background-color: var(--primary-background-color);

  }
  .bulkReportIndicator {
    @apply(--layout-horizontal);
  }
  .progressBlock {
    @apply(--layout-horizontal);
    @apply(--layout-center);
  }
  .progressBlock p {
    padding-left: 4px;
    font-size: 80%;
    color: var(--primary-text-color);
  }
  .outputTitle {
    font-style: italic;
    color: var(--secondary-text-color);
    font-size: 120%;
  }
  .outputBlock {
    padding: 10px;
    margin-top: 10px;
  }
  .outputBlock :after{
    content: '';
  }
  .indicatorsBlock, .indicatorReportBlock {
    padding-left: 2%;
  }
  .indicatorName {
    font-weight: bold;
  }
  paper-progress {
    --paper-progress-height: 6px;
  }
  paper-progress.blue {
    --paper-progress-active-color: var(--paper-light-blue-500);
    --paper-progress-secondary-color: var(--paper-light-blue-100);
  }
  paper-progress.red {
    --paper-progress-active-color: var(--paper-red-500);
    --paper-progress-secondary-color: var(--paper-red-100);
  }
  paper-progress.green {
    --paper-progress-active-color: var(--paper-light-green-500);
    --paper-progress-secondary-color: var(--paper-light-green-100);
  }
      iron-list {
        padding-top: 1px;
        padding-bottom: 16px;
        -webkit-flex: 1 1;
        flex: 1 1;
        --iron-list-items-container: {
          max-width: 800px;
          margin: auto;
          margin-top: 20px;
          margin-bottom: 20px;
          border-bottom: 1px solid #ddd;
        };
      }
      .item {
        @apply(--layout-horizontal);
        padding: 20px;
        background-color: white;
        border: 1px solid #ddd;
        cursor: pointer;
        margin-bottom: 10px;
      }
      .pad {
        padding: 0 16px;
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .primary {
        font-size: 16px;
        font-weight: bold;
      }
      .shortText, .longText {
        font-size: 14px;
      }
      .spacer {
        @apply(--layout-flex);
      }
      .item-body{
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .item-icon {
        @apply(--layout-flex);
        @apply(--layout-vertical);
      }
      .intLabel {
        font-size: 80%;
        color: var(--secondary-text-color);

      }
  </style>
    <etools-ajax
          auto
          id="ajax"
          url="[[url]]"
          handle-as="json"
          on-response="handleResponse"
          debounce-duration="300"
          loading="{{pageLoading}}">
    </etools-ajax>

  <h2>{{intervention.title}}</h2>
  <h3>Details</h3>
  <paper-material elevation="1">
    <p>
      <span class="intLabel">PCA number:</span> {{intervention.pca_number}}
    </p>
    <p>
      <span class="intLabel">Initiated:</span> {{dateFormat(intervention.initiation_date, 'LL')}}, 
      <span class="intLabel">Ending:</span> {{dateFormat(intervention.end_date, 'LL')}}, 
      <span class="intLabel">Reviewed</span> : {{dateFormat(intervention.review_date, 'LL')}}
    </p>
    <p>
      <span class="intLabel">Total Cash:</span> {{intervention.total_cash}}
      <span class="intLabel">Partner Contribution:</span> {{intervention.partner_contribution_budget}}
    </p>
  </paper-material>
  <h1 hidden$="[[!pageLoading]]">
      Page is loading now...
  </h1>
    <!-- <paper-tabs selected="{{selectedTab}}">

        <paper-tab>Indicators</paper-tab>
        <paper-tab>Report</paper-tab>

    </paper-tabs> -->

   
   <!--  <iron-pages selected="{{selectedTab}}">


      <section>  -->
      <h3>Indicators</h3>
        <paper-material elevation="1">
          <template is="dom-repeat" items="[[outputs]]" as="out">
            <div class="outputBlock">
              <p class="outputTitle">[[out.output.name]]</p>
              <iron-list id="list" items="[[out.indicators]]" as="rc">
                <template>
                    <div class="item"  on-tap="_goToReport" rc-id="{{rc.id}}" tabindex="0">
                        <div class="pad">
                          
                          <div class="primary">{{rc.indicator.name}}</div>
                          
                          
                          <div class="shortText">
                            <div class="progressBlock">
                              <paper-progress value="{{rc.current_progress}}" max="{{rc.target}}" class="blue"></paper-progress>
                              <p> {{rc.current_progress}}/{{rc.target}}</p>
                            </div>
                          </div>

                        </div>
                        <iron-icon icon="icons:chevron-right"></iron-icon>
                    </div>
                </template>
              </iron-list>
            </div>   
          </template>
        </paper-material>
     <!--  </section>

      <section>
        <paper-material  elevation="1">
        <div>
          <timeframe-picker label="Reporting Period" class="timeFrame"></timeframe-picker>
        </div>
        <hr>
        <template is="dom-repeat" items="[[outputs]]" as="out">
          <div class="outputBlock">
            <p class="outputTitle">[[out.output.name]]</p>
            <div class="indicatorsBlock">

              <template is="dom-repeat" items="[[out.indicators]]" as="rc">
                <p class="indicatorName">{{rc.indicator.name}} - <span on-tap="_goToReport" rc-id="{{rc.id}}">individual report</span></p>
                <div class="indicatorReportBlock">
                  <div class="progressBlock">
                    <paper-progress value="{{rc.current_progress}}" max="{{rc.target}}" class="blue"></paper-progress>
                    <p> {{rc.current_progress}}/{{rc.target}}</p>
                  </div>
                  <progress-bar current="{{rc.current_progress}}" against="{{rc.target}}"></progress-bar>
                  <div class="bulkReportIndicator">
                    <value-breakdown></value-breakdown><span>&nbsp;</span>
                    <locations-autocomplete id="locationSelected" label="Location"
                        autocomplete-url="{{appData.locationsAutocompleteEp}}">
                    </locations-autocomplete><span>&nbsp;</span>
                  </div>
                </div>
                <br>
              </template>

            </div>
          </div>   
        </template>

        <div class="reportButtons">
          <paper-button raised disabled={{submitDisabled}}>Submit Report</paper-button>
        </paper-material>
      </section>

      

    </iron-pages> -->
  
  

  </template>

</dom-module>


<script>
(function() {
    // jscs:disable
  'use strict';
  Polymer({
    is: 'intervention-details',
    behaviors: [commonBv.utils],
    properties: {
      selectedTab: {
        type: Number,
        value: 0
      },
      appData: {
        type: Object,
        // appData is received from the parent
        value: {}
      },
      pageLoading: Boolean,
      interventionId: {
        type: Number,
        value: null,
        observer: 'changeUrl'
      },
      intervention: {
        type: Object,
        value: null,
        observer: '_process_intervention'
      },
      indicators: {
        type: Array,
        value: null,
      },
      outputs: {
        type: Array,
        value: null,
      },
      url: {
        type: String,
        value: null
      }
    },
    changeUrl: function(){
      if (this.interventionId){
        this.intervention = null;
        this.indicators = null;
        this.url = this.appData.getEndpoint.interventionDetails(this.interventionId);
      } else {
        this.url = null;
      }
    },
    _process_intervention: function(intervention) {
        if (!intervention){
          return;
        }
        // need to get a dict of indicators filtered by output;
        var inds = [];
        var tempOutputs = {};
        intervention.results.forEach(function(el) {
          // el is the result_chain object
          // Make sure it's an indicator result
          if (!el.indicator){
            return;
          }
          inds.push(el);
          if (tempOutputs[el.result.id]){
            tempOutputs[el.result.id].indicators.push(el);
          } else {
            tempOutputs[el.result.id] = {};
            tempOutputs[el.result.id].output = el.result;
            tempOutputs[el.result.id].indicators = [el];
          }

        });
        var outputs = [];
        _.each(tempOutputs, function(value) {
            outputs.push(value);
        });
        this.indicators = inds;
        this.outputs = outputs;
    },
    _goToReport: function(ev){
      // go to the reporting page
      page(this.appData.baseUrl+'rcReport/'+this.interventionId+'/'+ ev.currentTarget.rcId + '/');

    },
    handleResponse: function(rsp) {
      // handle the response from the server
      this.intervention = rsp.detail.xhr.response;
    },
    _emptyObject: function(obj) {
      // for validation return false if object has no keys
      return (typeof(obj) === 'object') ? Object.keys(obj).length : false;
    },
    _toArray: function(obj) {
      // transform object to array
      return Object.keys(obj).map(function(key) {
          return {
              name: key,
              value: obj[key]
          };
      });
    }
  });
})();

</script>