
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../common/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">


<dom-module id="intervention-details">
  <template>
  <style>
  :host {
    
  }
  paper-card {
    @apply(--layout-horizontal);
    /*@apply(--layout-center);*/
    width: 80%;
    min-width: 260px;
    /*margin: 0 auto;*/
  }

  
  </style>
    <etools-ajax
          auto
          id="ajax"
          url="[[url]]"
          handle-as="json"
          on-response="handleResponse"
          debounce-duration="300"
          loading="{{pageLoading}}">
    </etools-ajax>
   
  <h2>{{intervention.title}}</h2>
  <h1 hidden$="[[!pageLoading]]">
      Page is loading now...
  </h1>
  
  <paper-card heading="All Indicators" image="" elevation="1" animated-shadow="false">
    <div class="card-content">
      <template is="dom-repeat" items="[[indicators]]" as="rc">
        <div on-tap="_goToReport" rc-id="{{rc.id}}">
          <h4 >Indicator Name: {{rc.indicator.name}}, id: {{rc.indicator.id}}</h4>
          <div>Partner Target Total: {{rc.target}}</div>
          <div>Partner Current Total: {{rc.current_progress}}</div>
          <div hidden$="[[!_emptyObject(result.disaggregation)]]">Dissagregate by: 
            <div>
              <template is="dom-repeat" items="[[_toArray(rc.disaggregation)]]">
                  <span>{{item.name}}, </span>
              </template>
            </div>
          </div>
        </div>  
        <br>
      </template>
    </div>
  </paper-card>
  <br> <br> <br>
  <paper-card heading="By Output" image="" elevation="1" animated-shadow="false">
    <div class="card-content">
      <template is="dom-repeat" items="[[outputs]]" as="out">
        <h3> Output: [[out.output.name]]</h3>
        <template is="dom-repeat" items="[[out.indicators]]" as="rc">
            <div on-tap="_goToReport" rc-id="{{rc.id}}">
              <h4 >Indicator Name: {{rc.indicator.name}}, id: {{rc.indicator.id}}</h4>
              <div>Partner Target Total: {{rc.target}}</div>
              <div>Partner Current Total: {{rc.current_progress}}</div>
              <div hidden$="[[!_emptyObject(result.disaggregation)]]">Dissagregate by: 
                <div>
                  <template is="dom-repeat" items="[[_toArray(rc.disaggregation)]]">
                      <span>{{item.name}}, </span>
                  </template>
                </div>
              </div>
            </div>  
            <br>
          </template>
        <br>
      </template>
    </div>
  </paper-card>
      

  </template>

</dom-module>


<script>
(function() {
    // jscs:disable
  'use strict';
  Polymer({
    is: 'intervention-details',
    properties: {
      appData: {
        type: Object,
        // appData is received from the parent
        value: {}
      },
      pageLoading: Boolean,
      interventionId: {
        type: Number,
        value: null,
        observer: 'changeUrl'
      },
      intervention: {
        type: Object,
        value: null,
        observer: '_process_intervention'
      },
      indicators: {
        type: Array,
        value: null,
      },
      outputs: {
        type: Array,
        value: null,
      },
      url: {
        type: String,
        value: null
      }
    },
    changeUrl: function(){
      if (this.interventionId){
        this.intervention = null;
        this.indicators = null;
        this.url = this.appData.getEndpoint.interventionDetails(this.interventionId);
      } else {
        this.url = null;
      }
    },
    _process_intervention: function(intervention) {
        if (!intervention){
          return;
        }
        // need to get a dict of indicators filtered by output;
        var inds = [];
        var tempOutputs = {};
        intervention.results.forEach(function(el) {
          // el is the result_chain object
          // Make sure it's an indicator result
          if (!el.indicator){
            return;
          }
          inds.push(el);
          if (tempOutputs[el.result.id]){
            tempOutputs[el.result.id].indicators.push(el);
          } else {
            tempOutputs[el.result.id] = {};
            tempOutputs[el.result.id].output = el.result;
            tempOutputs[el.result.id].indicators = [el];
          }

        });
        var outputs = [];
        _.each(tempOutputs, function(value) {
            outputs.push(value);
        });
        this.indicators = inds;
        this.outputs = outputs;
    },
    _goToReport: function(ev){
      // go to the reporting page
      page(this.appData.baseUrl+'rcReport/'+this.interventionId+'/'+ ev.currentTarget.rcId + '/');

    },
    handleResponse: function(rsp) {
      // handle the response from the server
      this.intervention = rsp.detail.xhr.response;
    },
    _emptyObject: function(obj) {
      // for validation return false if object has no keys
      return (typeof(obj) === 'object') ? Object.keys(obj).length : false;
    },
    _toArray: function(obj) {
      // transform object to array
      return Object.keys(obj).map(function(key) {
          return {
              name: key,
              value: obj[key]
          };
      });
    }
  });
})();

</script>