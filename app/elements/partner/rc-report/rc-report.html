
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../common/etools-ajax/etools-ajax.html">
<link rel="import" href="../../common/etools-datepicker/etools-datepicker.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">

  


<dom-module id="rc-report">
  <style>
  .custom {
    --primary-background-color: #FFFFFF;
  }
  
  </style>
  <template>
    <etools-ajax
          auto
          id="ajax"
          url="[[url]]"
          handle-as="json"
          on-response="handleResponse"
          debounce-duration="300">
    </etools-ajax>
    <etools-ajax
          auto
          id="ajaxPost"
          on-response="handleSubmitResponse"
          on-error="handleSubmitError">
    </etools-ajax>
   
  <h2>rcReport</h2>
  <div>{{rcId}}</div>
  <div>
      <p>Current Progress = {{rc.current_progress}}</p>
      <p>Target = {{rc.target}}</p>
      <p>Indicator = {{rc.indicator.name}}</p>
  </div>
  <div>
    <paper-button class="btn" on-tap="showNewReportDialog" raised>Add Report</paper-button>

    <!--  -->

    <paper-dialog class="custom" id="newReportDialog" modal on-iron-overlay-closed="dismissDialog">
      <p>Here we go </p>
      <paper-dialog-scrollable>
      <br>
        <paper-input label="Total Playaz" type="number" id="reportTotal"></paper-input>
        <br>
        <p>From: {{fromPrettyDate}}</p>
        <input id="fromDate" type="hidden" value="{{fromJsonDate}}">
        <etools-datepicker pretty-date="{{fromPrettyDate}}" json-date="{{fromJsonDate}}"></etools-datepicker>

        <p>From: {{toPrettyDate}}</p>
        <input id="toDate" type="hidden" value="{{toJsonDate}}">
        <etools-datepicker pretty-date="{{toPrettyDate}}" json-date="{{toJsonDate}}"></etools-datepicker>
        <br>
    </paper-dialog-scrollable>
      
      

      


      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>Submit</paper-button>
      </div>
      
    </paper-dialog>
  </div>


  
  </template>

</dom-module>


<script>
(function() {
    // jscs:disable
  'use strict';
  Polymer({
    is: 'rc-report',
    properties: {
      appData: {
        type: Object,
        // appData is received from the parent
        value: {}
      },
      rcId: {
        type: Number,
        value: null,
        observer: 'changeUrl'
      },
      rc: {
        type: Object,
        value: null,
        observer: 'update_view'
      },
      url: {
        type: String,
        value: null
      }
    },
    ready: function() {
      //
    },
    changeUrl: function(){
      
      if (this.rcId){
        this.rc = null;
        this.url = this.appData.getEndpoint.resultChainDetails(this.rcId);
      } else {
        this.url = null;
      }
    },
    handleResponse: function(rsp) {
      //
      this.rc = rsp.detail.xhr.response;

    },
    dateFormat: function(date, format) {
      return moment(date).format(format);
    },
    handleSubmitResponse: function(rsp){
      console.log(rsp.detail.xhr.response);
    },
    handleSubmitError: function(rsp){
      console.log(rsp.detail.error);
    },
    _submitReport: function() {
      var myReq = this.$.ajaxPost;
      myReq.body = {
        'total': this.$.reportTotal.value,
        'from_date': this.$.fromDate.value,
        'to_date': this.$.toDate.value
      };
      myReq.method = 'POST';
      myReq.url = this.appData.newIndicatorReportEp;
      myReq.sendPostRequest();
    },
    showNewReportDialog: function() {
      this.$.newReportDialog.toggle();
    },
    dismissDialog: function(event) {
      console.log('dismissing inside rc-report');
      if (event.detail.confirmed) {
        this._submitReport();
      }
      event.stopPropagation();
    },
    update_view: function() {
      var params = this.params;
      var interventions = this.interventions;
      if (!interventions || !params) { return; }

      var intervention = _.find(interventions, function(item) {
        console.log('item:', item);
        return item.id.toString() === params.rcIntvId;
      });
      console.log(intervention);

      // assuuming we have params otherwise we would not get to this view

    }
  });
})();

</script>