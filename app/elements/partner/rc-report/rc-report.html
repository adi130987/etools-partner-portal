
<link rel="import" href="../../../bower_components/polymer/polymer.html">

<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../common/etools-ajax/etools-ajax.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-list/iron-list.html">

<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker.html">
<link rel="import" href="../../../bower_components/paper-date-picker/paper-date-picker-dialog-style.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/moment-element/moment-with-locales-import.html">

  


<dom-module id="rc-report">
  <style is="custom-style" include="paper-date-picker-dialog-style">
  </style>
  <template>
    <etools-ajax
          auto
          id="ajax"
          url="[[url]]"
          handle-as="json"
          on-response="handleResponse"
          debounce-duration="300">
    </etools-ajax>
    <etools-ajax
          auto
          id="ajaxPost"
          on-response="handleSubmitResponse"
          on-error="handleSubmitError">
    </etools-ajax>
   
  <h2>rcReport</h2>
  <div>{{rcId}}</div>
  <div>
      <p>Current Progress = {{rc.current_progress}}</p>
      <p>Target = {{rc.target}}</p>
      <p>Indicator = {{rc.indicator.name}}</p>
  </div>
  <div>
  <paper-button class="btn" on-tap="showNewReportDialog" raised>Add Report</paper-button>
  <paper-dialog id="newReportDialog">
    <input type="number" id="reportTotal">
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm>OK</paper-button>
      </div>
     <section>
      <p>From: {{dateFormat(date, 'LL')}}</p>
      <input id="fromDate" type="hidden" value="{{dateFormat(date, '')}}">
      <paper-button class="btn" on-tap="showDialog" raised>Change</paper-button>
      <paper-dialog id="dialog" class="paper-date-picker-dialog" modal on-iron-overlay-closed="dismissDialog">
        <paper-date-picker id="picker" date="[[date]]"></paper-date-picker>
        <div class="buttons">
          <paper-button dialog-dismiss>Cancel</paper-button>
          <paper-button dialog-confirm>OK</paper-button>
        </div>
      </paper-dialog>
    </section>
    
    <button on-tap='_submitReport'>Submit Report</button>
    </paper-dialog>
  </div>
  
  </template>

</dom-module>


<script>
(function() {
    // jscs:disable
  'use strict';
  Polymer({
    is: 'rc-report',
    properties: {
      appData: {
        type: Object,
        // appData is received from the parent
        value: {}
      },
      rcId: {
        type: Number,
        value: null,
        observer: 'changeUrl'
      },
      rc: {
        type: Object,
        value: null,
        observer: 'update_view'
      },
      url: {
        type: String,
        value: null
      }
    },
    ready: function() {
      this.date = new Date();
    },
    changeUrl: function(){
      
      if (this.rcId){
        this.rc = null;
        this.url = this.appData.getEndpoint.resultChainDetails(this.rcId);
      } else {
        this.url = null;
      }
    },
    handleResponse: function(rsp) {
      //
      this.rc = rsp.detail.xhr.response;

    },
    dateFormat: function(date, format) {
      return moment(date).format(format);
    },
    handleSubmitResponse: function(rsp){
      this.disabledButton.disabled = false;
      console.log(rsp.detail.xhr.response);
    },
    handleSubmitError: function(rsp){
      console.log(rsp.detail.error);
      this.disabledButton.disabled = false;
    },
    _submitReport: function(ev) {
      this.disabledButton = ev.currentTarget;
      this.disabledButton.disabled = true;
      var myReq = this.$.ajaxPost;
      myReq.body = {
        'total': this.$.reportTotal.value
      };
      myReq.method = 'POST';
      myReq.url = this.appData.newIndicatorReportEp;
      myReq.sendPostRequest();
    },
    showDialog: function() {
      this.$.dialog.toggle();
    },
    showNewReportDialog: function() {
      this.$.newReportDialog.toggle();
    },
    dismissDialog: function(event) {
      if (event.detail.confirmed) {
        this.date = this.$.picker.date;
      }
    },
    update_view: function() {
      var params = this.params;
      var interventions = this.interventions;
      if (!interventions || !params) { return; }

      var intervention = _.find(interventions, function(item) {
        console.log('item:', item);
        return item.id.toString() === params.rcIntvId;
      });
      console.log(intervention);

      // assuuming we have params otherwise we would not get to this view

    }
  });
})();

</script>